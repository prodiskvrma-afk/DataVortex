<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid RAG Chatbot</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
  html, body {
    margin:0; padding:0; height:100%; width:100%;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    color: #e9ecef;
    display:flex;
    flex-direction:column;
  }

  .header {
    background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    padding:1rem; text-align:center;
    border-bottom:1px solid rgba(255,255,255,0.2);
  }
  .header h1 { margin:0; font-weight:600; color:#fff; }

  .chat-container {
    flex:1;
    display:flex;
    flex-direction:column;
    padding:1rem;
    overflow:hidden;
  }

  .chat-messages {
    flex:1;
    overflow-y:auto;
    scroll-behavior:smooth;
    padding-bottom:0.5rem;
  }

  .message {
    margin-bottom:1rem;
    display:flex;
    align-items:flex-start;
  }

  .message.user { justify-content:flex-end; }
  .message.bot { justify-content:flex-start; }

  .message-content {
    max-width:90%;
    padding:0.75rem 1rem;
    border-radius:18px;
    font-size:1rem;
    line-height:1.4;
    position:relative;
    transition:all 0.3s ease;
  }

  .message.user .message-content {
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:#fff; text-align:right; box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }
  .message.bot .message-content {
    background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2);
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    max-width:55%;
  }

  .avatar {
    width:35px; height:35px; border-radius:50%; margin:0 0.5rem;
    display:flex; align-items:center; justify-content:center; font-size:1.2rem;
  }
  .user .avatar { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; }
  .bot .avatar { background:rgba(255,255,255,0.2); color:#e9ecef; }

  .input-area {
    display:flex; gap:0.5rem; align-items:center; padding-top:0.5rem;
  }
  .input-area input {
    flex:1; border:1px solid rgba(255,255,255,0.3); border-radius:25px;
    padding:0.75rem 1.25rem; background:rgba(255,255,255,0.1); color:#e9ecef; font-size:1rem;
  }
  .input-area input::placeholder { color:rgba(233,236,239,0.7); }
  .input-area input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 2px rgba(102,126,234,0.3); }

  .input-area button {
    border-radius:50%; width:50px; height:50px; border:none;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:#fff; display:flex; align-items:center; justify-content:center;
    transition: transform 0.2s;
  }
  .input-area button:hover { transform:scale(1.05); }

  .typing-indicator {
    visibility:hidden; opacity:0; font-style:italic; color:rgba(233,236,239,0.7);
    padding:0.5rem; transition: opacity 0.3s ease, visibility 0s 0.3s;
    animation:pulse 1.5s infinite;
  }
  .typing-indicator.show { visibility:visible; opacity:1; transition:opacity 0.3s ease; }
  @keyframes pulse { 0%,100%{opacity:0.7;} 50%{opacity:1;} }

  .sources { font-size:0.8rem; color:#ccc; margin-top:0.25rem; }

  .stop-container {
    display: flex;
    justify-content: center;
    padding: 0.5rem;
  }

  .stop-btn {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .stop-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  }

  .stop-btn:active {
    transform: translateY(0);
  }
</style>
</head>
<body>
  <div class="header"><h1><i class="bi bi-robot"></i> RAG Chatbot</h1></div>

  <div class="chat-container">
    <div id="chat" class="chat-messages"></div>
    <div id="typing" class="typing-indicator">Bot is typing...</div>
    <div id="stop-container" class="stop-container" style="display: none;">
      <button onclick="stopResponse()" id="stop-btn" class="stop-btn">Stop Response</button>
    </div>

    <div class="input-area">
      <input type="text" id="query" placeholder="Ask me anything..." />
      <button onclick="sendMessage()"><i class="bi bi-send"></i></button>
      <button onclick="addDocument()" title="Add Document"><i class="bi bi-plus-circle"></i></button>
      <button onclick="clearChat()" title="Clear Chat"><i class="bi bi-trash"></i></button>
      <input type="file" id="fileInput" accept=".txt,.pdf" style="display: none;" onchange="handleFileSelect(event)" />
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("query");
    const typing = document.getElementById("typing");

    let isTyping = false;
    let shouldStopTyping = false;

    input.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

    async function sendMessage(){
      const userMsg = input.value.trim();
      if(!userMsg) return;
      addMessage(userMsg,"user");
      input.value="";
      typing.classList.add("show");
      showStopButton();
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch("/ask",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({query:userMsg})
        });
        if (!res.ok) {
          addMessage("HTTP Error: " + res.status, "bot");
          typing.classList.remove("show");
          hideStopButton();
          return;
        }
        const data = await res.json();
        if (data.error) {
          addMessage("Error: " + data.error, "bot");
          typing.classList.remove("show");
          hideStopButton();
        } else {
          typing.classList.remove("show");
          setTimeout(() => addMessage(data.answer,"bot",data.sources), 1000);
        }
      } catch(err){ console.error(err); addMessage("Network error: " + err.message, "bot"); typing.classList.remove("show"); hideStopButton(); }
    }

    function addMessage(text,type,sources=[]){
      const messageDiv=document.createElement("div");
      messageDiv.className=`message ${type}`;
      const avatar=document.createElement("div");
      avatar.className="avatar";
      avatar.innerHTML=type==="user" ? "<i class='bi bi-person'></i>" : "<i class='bi bi-robot'></i>";
      const content=document.createElement("div");
      content.className="message-content";
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);

      chat.appendChild(messageDiv);
      chat.scrollTop=chat.scrollHeight;

      if(type === "bot"){
        showStopButton();
        isTyping = true;
        typeWriter(content, text, sources);
      } else {
        content.textContent = text;
      }
    }

    function typeWriter(element, text, sources, index = 0) {
      if (shouldStopTyping) {
        // Stop typing and add sources if available
        if(sources.length>0){
          const sourcesDiv=document.createElement("div");
          sourcesDiv.className="sources";
          sourcesDiv.textContent="Sources: "+sources.join(", ");
          element.appendChild(sourcesDiv);
        }
        hideStopButton();
        isTyping = false;
        shouldStopTyping = false;
        return;
      }

      if (index < text.length) {
        element.textContent += text.charAt(index);
        chat.scrollTop = chat.scrollHeight;
        setTimeout(() => typeWriter(element, text, sources, index + 1), 20);
      } else {
        if(sources.length>0){
          const sourcesDiv=document.createElement("div");
          sourcesDiv.className="sources";
          sourcesDiv.textContent="Sources: "+sources.join(", ");
          element.appendChild(sourcesDiv);
        }
        hideStopButton();
        isTyping = false;
      }
    }

    function addDocument(){
      document.getElementById('fileInput').click();
    }

    function handleFileSelect(event){
      const file = event.target.files[0];
      if(!file){
        return;
      }
      if(!file.name.endsWith('.txt') && !file.name.endsWith('.pdf')){
        addMessage("Only .txt and .pdf files are supported.", "bot");
        return;
      }
      addMessage(`Uploading ${file.name}...`, "user");
      const formData = new FormData();
      formData.append('file', file);
      typing.classList.add("show");

      fetch('/add_document', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        typing.classList.remove("show");
        if(data.message){
          addMessage(data.message, "bot");
          setTimeout(() => {
            chat.innerHTML = "";
            addMessage("Document added successfully! You can now ask me questions about it.", "bot");
          }, 2000);
        } else {
          addMessage("Error: " + data.error, "bot");
        }
      })
      .catch(err => {
        console.error(err);
        typing.classList.remove("show");
        addMessage("Error adding document. Please try again.", "bot");
      });
      // Reset the input
      event.target.value = '';
    }

    function clearChat(){ chat.innerHTML=""; }

    function showStopButton() {
      const stopContainer = document.getElementById("stop-container");
      stopContainer.style.display = "flex";
    }

    function hideStopButton() {
      const stopContainer = document.getElementById("stop-container");
      stopContainer.style.display = "none";
    }

    function stopResponse() {
      if (isTyping) {
        shouldStopTyping = true;
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
